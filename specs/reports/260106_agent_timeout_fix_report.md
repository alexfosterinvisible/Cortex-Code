# Agent Timeout Bug Fix Report (Claude)

**Date**: 2026-01-06
**Bug Type**: Critical - Indefinite Process Hang
**Status**: FIXED

---

## Problem Summary

The ADW agent execution layer had a critical bug that caused Claude Code processes to hang indefinitely when:
1. The Claude API was unresponsive
2. The CLI produced no output for extended periods
3. Rate limiting or network issues occurred

This was discovered during the SDLC timing diagnostic where 5 parallel ZTE workflows all hung at `/classify_issue`, accumulating 80+ Claude processes and exhausting system resources.

---

## Root Cause

In `adw/core/agent.py`, the code used `subprocess.Popen` with a streaming loop:

```python
result = subprocess.Popen(cmd, ...)
for line in result.stdout:  # <-- Blocks indefinitely if no output
    ...
result.wait()  # <-- No timeout
```

The `for line in result.stdout` iterator blocks waiting for input. If Claude Code hangs without producing output, this loop waits forever.

---

## Fix Applied

### 1. Watchdog Timer with Process Killing

Added a threading.Timer-based watchdog that kills the process after timeout:

```python
def kill_on_timeout(proc):
    """Kill process if it exceeds timeout."""
    os.killpg(os.getpgid(proc.pid), signal.SIGTERM)
    time.sleep(1)
    if proc.poll() is None:
        os.killpg(os.getpgid(proc.pid), signal.SIGKILL)

watchdog = threading.Timer(timeout_seconds, kill_on_timeout, args=[result])
watchdog.daemon = True
watchdog.start()
```

### 2. Process Group for Clean Termination

Added `start_new_session=True` to create a new process group, ensuring all child processes are killed:

```python
result = subprocess.Popen(
    cmd,
    start_new_session=True,  # Create new process group
    ...
)
```

### 3. Configurable Timeout

Timeout is now configurable via:

- **`.adw.yaml`**:
  ```yaml
  agent:
    timeout_seconds: 300
    max_retries: 3
    retry_delays: [1, 3, 5]
  ```

- **Environment variable**: `ADW_AGENT_TIMEOUT=300`

### 4. Improved Retry Logic

Updated `prompt_claude_code_with_retry()` to use config values for `max_retries` and `retry_delays`.

---

## Files Changed

| File | Change |
|------|--------|
| `adw/core/agent.py` | Added timeout watchdog, process killing, config integration |
| `adw/core/config.py` | Added `AgentConfig` dataclass |
| `tests/conftest.py` | Updated mock to include `AgentConfig` |
| `.adw.yaml` | Added `agent:` config section |
| `CLAUDE.md` | Documented agent configuration |

---

## Test Results

All 346 unit tests pass after the fix.

---

## Verification Steps

To verify the fix works:

1. Set a short timeout: `ADW_AGENT_TIMEOUT=10`
2. Run a command that would hang (e.g., if API is down)
3. After 10 seconds, the process should be killed and return `TIMEOUT_ERROR`
4. The error message should show: "Process was killed to prevent resource exhaustion"

---

## Recommended Next Steps

1. Re-run the SDLC timing diagnostic to verify workflows complete
2. Consider adding circuit breaker pattern for consecutive failures
3. Add health check before workflow to verify Claude CLI is working
4. Add monitoring/alerting for timeout events in production

---

*Report generated by Claude Code bug fix workflow*
